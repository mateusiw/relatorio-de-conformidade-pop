<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Qualidade - POPs</title>
    
    <!-- Meta tags para PWA (Aparência de App) -->
    <meta name="theme-color" content="#059669"> <!-- Cor Esmeralda -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="https://i.imgur.com/1WtyGvS.png">

    <!-- Tailwind CSS (Estilização) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ícones -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Estilos específicos para impressão */
        @media print {
            @page {
                margin: 1cm; /* Margens estreitas para aproveitar a folha */
                size: A4;
            }

            body, html {
                background: white;
                color: black;
                font-size: 10pt; /* Fonte um pouco menor para caber mais */
                margin: 0;
                padding: 0;
            }

            .no-print { display: none !important; }
            .print-border { border: 1px solid #ccc; }
            
            /* Inputs e Selects na impressão */
            input[type="text"], input[type="date"], select { 
                border: none; 
                border-bottom: 1px solid #000; 
                padding: 0; 
                margin: 0;
                appearance: none; 
                -webkit-appearance: none; 
                background: transparent; 
                height: auto;
                width: 100% !important; /* FORÇAR LARGURA TOTAL PARA A LINHA ESTICAR */
                display: block;
                font-size: 10pt;
                line-height: 1.2;
            }

            /* TRUQUE PARA ESCONDER dd/mm/aaaa NA IMPRESSÃO */
            input[type="date"] { color: transparent; }
            input[type="date"].has-value { color: black; }
            input[type="date"]::-webkit-calendar-picker-indicator { display: none; }
            
            /* Ajuste da TextArea na impressão */
            textarea { 
                border: 1px solid #999 !important; 
                resize: none;
                background: transparent;
                min-height: 1.8cm !important; /* Altura compacta mas suficiente */
                box-shadow: none !important;
                margin-top: 2px !important;
                display: block !important;
                page-break-inside: avoid;
                font-size: 10pt;
                width: 100%;
            }

            /* Container da pergunta */
            .question-container {
                page-break-inside: avoid; /* A pergunta individual não quebra no meio */
                border: none !important; 
                padding: 0.1cm 0 !important; 
                box-shadow: none !important;
                margin-bottom: 0.2cm !important;
                border-bottom: 1px dashed #ccc !important; 
            }

            /* Layout Global de Impressão */
            main { 
                margin: 0 !important; 
                padding: 0 !important; 
                width: 100% !important; 
                max-width: none !important; 
                box-shadow: none !important; 
            }
            
            /* Reduzir espaçamento vertical entre elementos */
            .space-y-8 > :not([hidden]) ~ :not([hidden]) { margin-top: 0 !important; } 
            
            /* Cabeçalhos de seção */
            h3 { 
                font-size: 11pt !important; 
                margin-top: 0.3cm !important; /* Espaço antes do título */
                margin-bottom: 0.1cm !important; 
                padding: 0.1cm !important;
                background-color: #f0f0f0 !important; 
                color: #000 !important;
                border-left: 3px solid #000 !important;
                page-break-after: avoid; /* Título gruda no conteúdo */
            }

            /* Botões de opção (C/NC/NA) */
            .radio-label {
                border: 1px solid #000 !important;
                color: #000 !important;
                background: none !important;
                padding: 1px 6px !important;
                font-size: 9pt !important;
                border-radius: 4px !important;
            }

            select { background-image: none; }
            
            /* PERMITIR QUEBRA FLUIDA */
            section { 
                page-break-inside: auto !important; 
                page-break-after: auto !important; 
                margin-bottom: 0 !important;
                display: block !important;
            }
            
            /* Esconder ícones decorativos na impressão */
            i[data-lucide] { display: none !important; }
            
            /* Ajuste de layout do cabeçalho para ser horizontal */
            /* IMPORTANTE: Garante que o grid de tela suma na impressão */
            .screen-only-grid { display: none !important; }

            .header-info-grid {
                display: grid !important; /* Força display grid na impressão */
                grid-template-columns: 1fr 1fr 1fr; /* 3 colunas */
                gap: 10px;
                margin-top: 10px;
                font-size: 9pt;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 10px;
            }
            
            .header-info-item label { font-weight: bold; display: block; }
            .header-info-item input { width: 100%; }
        }
        
        /* Estilos de tela (Screen) */
        .radio-option:checked + label {
            background-color: #059669; /* Verde Esmeralda */
            color: white;
            border-color: #059669;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans min-h-screen pb-24">

    <!-- Cabeçalho (Fixo no topo em mobile) -->
    <header class="bg-emerald-600 text-white shadow-md sticky top-0 z-50 no-print">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <!-- Usando a logo do imgur também no topo do app -->
                <img src="https://i.imgur.com/1WtyGvS.png" alt="Logo" class="h-8 w-auto bg-white rounded p-0.5">
                Gestão de POPs
            </h1>
            <div class="flex gap-2">
                <button onclick="resetForm()" class="p-2 bg-emerald-700 rounded hover:bg-emerald-800 transition" title="Limpar Formulário Atual">
                    <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                </button>
                
                <!-- Botão Exportar CSV -->
                <button onclick="exportToCSV()" class="p-2 bg-yellow-500 rounded hover:bg-yellow-600 transition font-bold flex items-center gap-1 text-emerald-900" title="Exportar para Excel (CSV)">
                    <i data-lucide="file-spreadsheet" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Exportar</span>
                </button>

                <button onclick="window.print()" class="p-2 bg-green-800 rounded hover:bg-green-900 transition font-bold flex items-center gap-1">
                    <i data-lucide="printer" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Imprimir</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 md:p-8 bg-white shadow-xl mt-4 mb-8 rounded-lg print:shadow-none print:mt-0 print:w-full">
        
        <!-- SELEÇÃO DE POP (Dropdown - Não imprime) -->
        <div class="bg-emerald-50 p-4 rounded-lg border border-emerald-200 mb-8 no-print">
            <div class="mb-4">
                <label class="block text-sm font-bold text-emerald-800 mb-2 uppercase tracking-wide">
                    <i data-lucide="library" class="inline w-4 h-4 mr-1"></i> Selecione o Procedimento (POP)
                </label>
                <select id="popSelect" onchange="changePOP()" class="w-full p-3 border-2 border-emerald-300 rounded-md focus:ring-2 focus:ring-emerald-500 focus:outline-none bg-white text-lg font-medium shadow-sm">
                    <option value="pop01">POP 01 - HIGIENE E SAÚDE DOS MANIPULADORES</option>
                    <option value="pop02">POP 02 - HIGIENIZAÇÃO DE INSTALAÇÕES E EQUIPAMENTOS</option>
                    <option value="pop03">POP 03 - MANEJO DE RESÍDUOS</option>
                    <option value="pop04">POP 04 - CONTROLE INTEGRADO DE VETORES E PRAGAS</option>
                    <option value="pop05">POP 05 - CONTROLE DA POTABILIDADE DE ÁGUA</option>
                    <option value="pop06">POP 06 - SELEÇÃO DE MATÉRIAS-PRIMAS E EMBALAGENS</option>
                    <option value="pop07">POP 07 - MANUTENÇÃO PREVENTIVA E CALIBRAÇÃO</option>
                </select>
            </div>

            <!-- SELEÇÃO DE SUB-GRUPOS (Dinâmico) -->
            <div id="sub-selection-container" class="border-t border-emerald-200 pt-4 hidden">
                <p class="text-sm font-bold text-emerald-800 mb-3 flex items-center gap-2">
                    <i data-lucide="list-checks" class="w-4 h-4"></i>
                    Selecione os grupos para avaliar/imprimir:
                </p>
                <div id="sub-selection-list" class="flex flex-wrap gap-3">
                    <!-- Checkboxes injetados via JS -->
                </div>
            </div>
        </div>

        <!-- Cabeçalho do Relatório (Impresso) -->
        <div class="print:block">
            <div class="flex justify-between items-start mb-4 print:mb-2">
                <div class="flex items-center gap-4">
                    <!-- Logo ATUALIZADA (Aparece na impressão) -->
                    <img src="https://i.imgur.com/1WtyGvS.png" alt="Logo" class="h-20 w-auto hidden print:block">
                    
                    <div>
                        <!-- Título -->
                        <h2 id="report-title" class="text-2xl font-bold text-gray-800 uppercase print:text-lg print:leading-tight">Lista de Verificação</h2>
                        <p id="report-subtitle" class="text-gray-500 text-sm mt-1 print:text-xs">Selecione um POP acima</p>
                    </div>
                </div>
                <div class="text-right hidden print:block">
                    <div class="text-xs text-gray-500">Emissão: <span id="pop-date">--/--/----</span></div>
                    <div class="text-xs text-gray-500">Rev: <span id="pop-rev">00</span></div>
                </div>
            </div>

            <!-- Grid de Informações (Otimizado para Impressão Horizontal) -->
            <!-- Adicionei a classe "screen-only-grid" para garantir que suma na impressão -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 screen-only-grid">
                <!-- Layout de TELA -->
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Responsável pela Avaliação:</label>
                    <input type="text" id="responsavel-screen" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-emerald-500 focus:outline-none" placeholder="" oninput="syncInputs('responsavel', this.value)">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Data da Avaliação:</label>
                    <input type="date" id="data-screen" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-emerald-500 focus:outline-none" oninput="syncInputs('data', this.value)">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Setor Avaliado:</label>
                    <input type="text" id="setor-screen" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-emerald-500 focus:outline-none" placeholder="" oninput="syncInputs('setor', this.value)">
                </div>
            </div>

            <!-- Layout APENAS DE IMPRESSÃO (Compacto) -->
            <div class="hidden print:grid header-info-grid">
                <div class="header-info-item">
                    <label>Responsável:</label>
                    <input type="text" id="responsavel-print">
                </div>
                <div class="header-info-item">
                    <label>Data:</label>
                    <input type="date" id="data-print">
                </div>
                <div class="header-info-item">
                    <label>Setor:</label>
                    <input type="text" id="setor-print">
                </div>
            </div>
        </div>

        <!-- Área Dinâmica dos Questionários -->
        <form id="checklistForm" class="space-y-8 print:space-y-0">
            
            <!-- Legenda (Opcional na impressão se quiser economizar espaço, mas útil) -->
            <div class="bg-emerald-50 border-l-4 border-emerald-500 p-3 mb-4 rounded text-sm text-emerald-800 print:bg-white print:border print:border-gray-300 print:text-gray-600 print:text-xs print:mb-2 print:p-1 print:border-l-2">
                <span class="font-bold mr-2">Legenda:</span>
                <span class="mr-4"><strong>C</strong> = Conforme</span>
                <span class="mr-4"><strong>NC</strong> = Não Conforme</span>
                <span><strong>NA</strong> = Não Avaliado</span>
            </div>

            <div id="dynamic-content">
                <!-- O conteúdo das perguntas será injetado aqui via JavaScript -->
            </div>

            <!-- Observações Gerais -->
            <section class="mt-8 border-t pt-4 print:mt-4 print:pt-2">
                <h3 class="text-lg font-bold text-gray-700 mb-2 print:text-sm print:mb-1 print:bg-transparent print:p-0 print:border-none">Observações Gerais / Ações Corretivas</h3>
                <textarea id="obs-geral" rows="4" class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-emerald-500 focus:outline-none" placeholder="" oninput="saveProgress()"></textarea>
            </section>

            <!-- Rodapé de Assinatura -->
            <section class="mt-12 pt-6 border-t-2 border-gray-300 print:mt-4 print:pt-2 print:border-t">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12 print:gap-4 print:grid-cols-2">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 print:text-xs">Aprovado por:</label>
                        <!-- Removido o placeholder para ficar em branco na impressão -->
                        <input type="text" id="aprovado-por" class="w-full p-2 border-b-2 border-black bg-gray-50 focus:bg-white focus:border-emerald-600 transition-colors outline-none font-medium print:bg-transparent print:border-b print:p-0 print:h-8" placeholder="" oninput="saveProgress()">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 print:text-xs">Assinatura:</label>
                        <!-- Campo digitável para assinatura (text), sem o disabled -->
                        <input type="text" id="assinatura-digital" class="w-full p-2 border-b-2 border-black bg-gray-50 focus:bg-white focus:border-emerald-600 transition-colors outline-none font-medium print:bg-transparent print:border-b print:p-0 print:h-8" placeholder="" oninput="saveProgress()">
                    </div>
                </div>
            </section>
        </form>
    </main>

    <!-- Barra de Status Flutuante -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 no-print z-40">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <span class="text-sm text-gray-500">Conformidade (<span id="current-pop-label">POP --</span>):</span>
                <div class="text-2xl font-bold text-emerald-600" id="score-display">0%</div>
            </div>
            <div class="text-right text-xs text-gray-400">
                Itens Conformes: <span id="count-c">0</span> | Não Conformes: <span id="count-nc">0</span>
            </div>
        </div>
    </div>

    <script>
        let currentPOP = 'pop01';
        let currentVisibleGroups = []; 

        // --- DADOS (Mantidos iguais aos anteriores) ---
        const popsData = {
            'pop01': {
                title: "HIGIENE E SAÚDE DOS MANIPULADORES",
                subtitle: "Baseado no POP 01 - Revisão 00 - 22/11/2025",
                date: "22/11/2025",
                rev: "00",
                groups: [
                    {
                        title: "1. Saúde e Documentação",
                        questions: [
                            { id: 'p01_q1', text: 'ASO (Atestado de Saúde Ocupacional) dos manipuladores está em dia (Admissional/Periódico)?' },
                            { id: 'p01_q2', text: 'Manipuladores sem sinais de infecções (pulmonares, faringites), febre, vômitos ou diarreia?' },
                            { id: 'p01_q3', text: 'Ausência de feridas, cortes ou lesões expostas nas mãos e braços?' }
                        ]
                    },
                    {
                        title: "2. Higiene Pessoal e Uniformes",
                        questions: [
                            { id: 'p01_q4', text: 'Uniforme completo (blusa, calça) e limpo?' },
                            { id: 'p01_q5', text: 'Uso correto de toucas (cabelos totalmente protegidos)?' },
                            { id: 'p01_q6', text: 'Calçados fechados (botas brancas) em bom estado de conservação?' },
                            { id: 'p01_q7', text: 'Ausência de adornos (anéis, alianças, relógios, pulseiras, brincos, correntes)?' },
                            { id: 'p01_q8', text: 'Unhas curtas, limpas e sem esmalte ou base?' },
                            { id: 'p01_q9', text: 'Ausência de barba e bigode?' },
                            { id: 'p01_q10', text: 'Manipuladores sem maquiagem e sem perfume forte?' }
                        ]
                    },
                    {
                        title: "3. Comportamento Operacional",
                        questions: [
                            { id: 'p01_q11', text: 'Funcionários não fumam, tossem, espirram ou cospem próximo aos alimentos?' },
                            { id: 'p01_q12', text: 'Funcionários evitam falar excessivamente sobre os alimentos?' },
                            { id: 'p01_q13', text: 'Manipuladores não manipulam dinheiro durante o serviço?' },
                            { id: 'p01_q14', text: 'Realizam a lavagem das mãos corretamente após riscos de contaminação?' }
                        ]
                    },
                    {
                        title: "4. Instalações e Visitantes",
                        questions: [
                            { id: 'p01_q15', text: 'Pia exclusiva para mãos abastecida (sabão bactericida, papel toalha)?' },
                            { id: 'p01_q16', text: 'Cartazes orientativos de lavagem de mãos fixados e visíveis?' },
                            { id: 'p01_q17', text: 'Visitantes cumprem as regras (touca, sem adornos, sem tocar nos alimentos)?' }
                        ]
                    }
                ]
            },
            'pop02': {
                title: "HIGIENIZAÇÃO DAS INSTALAÇÕES, MÓVEIS E UTENSÍLIOS",
                subtitle: "Baseado no POP 02 - Revisão 00 - 22/11/2025",
                date: "22/11/2025",
                rev: "00",
                groups: [
                    {
                        title: "1. Disponibilidade de Materiais e Produtos",
                        questions: [
                            { id: 'p02_q1', text: 'Detergentes e sanitizantes estão disponíveis em quantidade suficiente?' },
                            { id: 'p02_q2', text: 'Utensílios de limpeza (baldes, vassouras, rodos) estão disponíveis e em bom estado?' },
                            { id: 'p02_q3', text: 'Instalações possuem água fria em quantidade suficiente?' }
                        ]
                    },
                    {
                        title: "2. Aquisição, Estocagem e Identificação",
                        questions: [
                            { id: 'p02_q4', text: 'Produtos de higiene possuem registro no Ministério da Saúde?' },
                            { id: 'p02_q5', text: 'Produtos são sem odorizantes (sem cheiro forte)?' },
                            { id: 'p02_q6', text: 'Produtos estão armazenados corretamente no almoxarifado?' },
                            { id: 'p02_q7', text: 'Utensílios de limpeza são separados e identificados por área (Ex: Banheiro separados da Produção)?' }
                        ]
                    },
                    {
                        title: "3. Higienização Diária",
                        questions: [
                            { id: 'p02_q8', text: 'Pisos, rodapés e ralos estão limpos?' },
                            { id: 'p02_q9', text: 'Pias e tanques estão limpos?' },
                            { id: 'p02_q10', text: 'Banheiros/Sanitários estão higienizados?' },
                            { id: 'p02_q11', text: 'Equipamentos (máquinas, câmaras frias) e utensílios estão limpos e sanitizados?' },
                            { id: 'p02_q12', text: 'Coletores de lixo estão limpos e tampados?' }
                        ]
                    },
                    {
                        title: "4. Higienização Semanal e Mensal",
                        questions: [
                            { id: 'p02_q13', text: 'Paredes, portas e janelas estão limpas? (Semanal)' },
                            { id: 'p02_q14', text: 'Prateleiras estão limpas e organizadas? (Semanal)' },
                            { id: 'p02_q15', text: 'Luminárias, teto ou forro estão limpos? (Mensal)' },
                            { id: 'p02_q16', text: 'Caixas de isopor (se houver) estão limpas?' }
                        ]
                    }
                ]
            },
            'pop03': {
                title: "MANEJO DE RESÍDUOS",
                subtitle: "Baseado no POP 03 - Revisão 00 - 24/11/2025",
                date: "24/11/2025",
                rev: "00",
                groups: [
                    {
                        title: "1. Acondicionamento e Coleta",
                        questions: [
                            { id: 'p03_q1', text: 'Lixeiras de áreas críticas (pias, manipulação, banheiros) possuem pedal e tampa?' },
                            { id: 'p03_q2', text: 'Lixo de escritório está acondicionado em sacos plásticos resistentes?' },
                            { id: 'p03_q3', text: 'Resíduos orgânicos são separados em caixas plásticas específicas?' },
                            { id: 'p03_q4', text: 'Resíduos recicláveis são coletados e separados em local determinado?' }
                        ]
                    },
                    {
                        title: "2. Higiene e Frequência",
                        questions: [
                            { id: 'p03_q5', text: 'Lixeiras são lavadas diariamente ou quando necessário?' },
                            { id: 'p03_q6', text: 'Lixo orgânico é descartado diariamente?' },
                            { id: 'p03_q7', text: 'Áreas internas e externas estão limpas e sem acúmulo de lixo (Observação Visual)?' }
                        ]
                    },
                    {
                        title: "3. Controle de Instalações (Preventivo)",
                        questions: [
                            { id: 'p03_q8', text: 'Instalações (portas e aberturas) mantidas fechadas para evitar insetos/roedores?' },
                            { id: 'p03_q9', text: 'Ausência de lixo derramado fora das lixeiras?' }
                        ]
                    }
                ]
            },
            'pop04': {
                title: "CONTROLE INTEGRADO DE VETORES E PRAGAS",
                subtitle: "Baseado no POP 04 - Revisão 00 - 24/11/2025",
                date: "24/11/2025",
                rev: "00",
                groups: [
                    {
                        title: "1. Instalações e Acesso (Barreiras Físicas)",
                        questions: [
                            { id: 'p04_q1', text: 'Ralos, portas e aberturas estão protegidos para evitar entrada de pragas?' },
                            { id: 'p04_q2', text: 'As instalações estão livres de buracos ou frestas que sirvam de abrigo?' },
                            { id: 'p04_q3', text: 'Área externa está livre de acúmulo de sucatas, ninhos ou água parada?' }
                        ]
                    },
                    {
                        title: "2. Controle de Resíduos e Ambiente",
                        questions: [
                            { id: 'p04_q4', text: 'Resíduos (alimentos/embalagens) são removidos diariamente?' },
                            { id: 'p04_q5', text: 'Lixeiras e local de armazenamento de lixo estão higienizados?' },
                            { id: 'p04_q6', text: 'Ausência de animais domésticos na área da empresa?' }
                        ]
                    },
                    {
                        title: "3. Monitoramento Visual (Diário)",
                        questions: [
                            { id: 'p04_q7', text: 'AUSÊNCIA de sinais de roedores (fezes, roídos, trilhas)?' },
                            { id: 'p04_q8', text: 'AUSÊNCIA de baratas, formigas ou outros insetos?' },
                            { id: 'p04_q9', text: 'AUSÊNCIA de cupins nas estruturas?' }
                        ]
                    },
                    {
                        title: "4. Empresa Terceirizada (Controle Químico)",
                        questions: [
                            { id: 'p04_q10', text: 'Serviço de desinsetização/desratização está em dia (Trimestral)?' },
                            { id: 'p04_q11', text: 'A empresa terceirizada possui licença sanitária válida?' },
                            { id: 'p04_q12', text: 'Certificados e ordem de serviço dos produtos utilizados estão arquivados?' }
                        ]
                    }
                ]
            },
            'pop05': {
                title: "CONTROLE DA POTABILIDADE DE ÁGUA",
                subtitle: "Baseado no POP 05 - Revisão 00 - 25/11/2025",
                date: "25/11/2025",
                rev: "00",
                groups: [
                    {
                        title: "1. Higienização de Reservatórios",
                        questions: [
                            { id: 'p05_q1', text: 'A limpeza da caixa d\'água foi realizada nos últimos 6 meses (Semestral)?' },
                            { id: 'p05_q2', text: 'A caixa d\'água está devidamente tampada e protegida contra entrada de animais/sujeira?' },
                            { id: 'p05_q3', text: 'Existe registro (planilha/ficha) assinado da última limpeza realizada?' }
                        ]
                    },
                    {
                        title: "2. Análises Laboratoriais",
                        questions: [
                            { id: 'p05_q4', text: 'A empresa possui laudo de análise microbiológica da água dentro da validade (Semestral)?' },
                            { id: 'p05_q5', text: 'A empresa possui laudo de análise físico-química da água dentro da validade (Anual)?' },
                            { id: 'p05_q6', text: 'Os laudos atestam que a água está própria para consumo (satisfatória)?' }
                        ]
                    }
                ]
            },
            'pop06': {
                title: "SELEÇÃO DE MATÉRIAS-PRIMAS E EMBALAGENS",
                subtitle: "Baseado no POP 06 - Revisão 00 - 29/11/2025",
                date: "29/11/2025",
                rev: "00",
                groups: [
                    {
                        title: "1. Avaliação de Matéria-Prima (Recebimento)",
                        questions: [
                            { id: 'p06_q1', text: 'Hortifruti (brócolis, couve-flor, pepino, tomate) seguem o padrão de qualidade visual da empresa?' },
                            { id: 'p06_q2', text: 'Ausência de sinais de deterioração, podridão ou pragas nos vegetais recebidos?' }
                        ]
                    },
                    {
                        title: "2. Avaliação de Embalagens e Documentação",
                        questions: [
                            { id: 'p06_q3', text: 'A Nota Fiscal (NF) e destinatário foram conferidos e estão corretos?' },
                            { id: 'p06_q4', text: 'O número de volumes físico confere com a nota fiscal?' },
                            { id: 'p06_q5', text: 'As embalagens/volumes estão íntegros e sem sinais de violação?' },
                            { id: 'p06_q6', text: 'As informações (origem, descrição, quantidade) conferem com a mercadoria física?' }
                        ]
                    },
                    {
                        title: "3. Ações Corretivas",
                        questions: [
                            { id: 'p06_q7', text: 'Produtos fora do padrão foram devolvidos ou segregados imediatamente?' }
                        ]
                    }
                ]
            },
            'pop07': {
                title: "MANUTENÇÃO PREVENTIVA E CALIBRAÇÃO",
                subtitle: "Baseado no POP 07 - Revisão 00 - 01/12/2025",
                date: "01/12/2025",
                rev: "00",
                groups: [
                    {
                        title: "1. Manutenção de Equipamentos",
                        questions: [
                            { id: 'p07_q1', text: 'A manutenção é realizada conforme necessidade (corretiva ou preventiva)?' },
                            { id: 'p07_q2', text: 'Manutenção de Câmaras Frias está em dia?' },
                            { id: 'p07_q3', text: 'As Ordens de Serviço (OS) e Notas Fiscais das manutenções estão arquivadas?' }
                        ]
                    },
                    {
                        title: "2. Calibração (Balanças e Termômetros)",
                        questions: [
                            { id: 'p07_q4', text: 'Calibração das Balanças está em dia (Anual)?' },
                            { id: 'p07_q5', text: 'Calibração dos Termômetros está em dia (Anual)?' },
                            { id: 'p07_q6', text: 'Possui os Certificados/Laudos de Calibração emitidos por empresa autorizada/Inmetro?' }
                        ]
                    },
                    {
                        title: "3. Ações Corretivas e Verificação",
                        questions: [
                            { id: 'p07_q7', text: 'Equipamentos descalibrados tiveram operação suspensa imediatamente?' },
                            { id: 'p07_q8', text: 'Foi realizada substituição ou manutenção de equipamento com defeito?' }
                        ]
                    }
                ]
            }
        };

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // Tentar recuperar último POP selecionado
            const lastPOP = localStorage.getItem('last_selected_pop');
            if (lastPOP && popsData[lastPOP]) {
                document.getElementById('popSelect').value = lastPOP;
            }
            // Força a atualização do POP inicial (carrega dados, define grupos visíveis, renderiza)
            changePOP();
        });

        // --- SINCRONIZAÇÃO DE CAMPOS (TELA <-> IMPRESSÃO) ---
        function syncInputs(type, value) {
            // Atualiza os inputs ocultos de impressão quando digita na tela e vice-versa
            document.getElementById(`${type}-print`).value = value;
            document.getElementById(`${type}-screen`).value = value;
            saveProgress();
        }

        // --- TROCA DE POP E CARREGAMENTO ---
        function changePOP() {
            currentPOP = document.getElementById('popSelect').value;
            localStorage.setItem('last_selected_pop', currentPOP);
            
            const storageKey = `data_${currentPOP}`;
            const savedJSON = localStorage.getItem(storageKey);
            const savedData = savedJSON ? JSON.parse(savedJSON) : null;

            // 1. Determinar Grupos Visíveis (Inicia VAZIO se não houver salvo)
            if (savedData && savedData.meta && savedData.meta.visibleGroups) {
                currentVisibleGroups = savedData.meta.visibleGroups;
            } else {
                currentVisibleGroups = []; // Padrão: Nenhum selecionado
            }

            // 2. Renderizar Checkboxes de Seleção
            renderSubSelection();

            // 3. Renderizar Formulário (baseado nos grupos visíveis)
            renderPOP();

            // 4. Preencher dados salvos nos campos
            if (savedData) fillFormData(savedData);
            
            // Atualizar estatísticas após carregar
            updateStats();
        }

        // --- RENDERIZAÇÃO DOS CHECKBOXES ---
        function renderSubSelection() {
            const container = document.getElementById('sub-selection-container');
            const list = document.getElementById('sub-selection-list');
            list.innerHTML = ''; // Limpar

            popsData[currentPOP].groups.forEach((group, index) => {
                const isChecked = currentVisibleGroups.includes(index) ? 'checked' : '';
                
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-2 rounded border border-emerald-100 hover:bg-emerald-50 transition select-none shadow-sm">
                        <input type="checkbox" class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500" 
                            value="${index}" onchange="toggleGroup(${index})" ${isChecked}>
                        <span class="text-gray-700 font-medium text-sm">${group.title}</span>
                    </label>
                `;
                list.appendChild(div.firstElementChild);
            });
            
            container.classList.remove('hidden');
        }

        function toggleGroup(index) {
            saveProgress(); 

            const checkbox = document.querySelector(`input[type="checkbox"][value="${index}"]`);
            if (checkbox.checked) {
                if (!currentVisibleGroups.includes(index)) currentVisibleGroups.push(index);
            } else {
                currentVisibleGroups = currentVisibleGroups.filter(i => i !== index);
            }
            currentVisibleGroups.sort((a, b) => a - b); 

            renderPOP();
            
            const savedData = JSON.parse(localStorage.getItem(`data_${currentPOP}`));
            if(savedData) fillFormData(savedData);
            
            saveProgress();
        }

        // --- RENDERIZAÇÃO DO CONTEÚDO ---
        function renderPOP() {
            const data = popsData[currentPOP];
            
            document.getElementById('report-title').innerText = data.title;
            document.getElementById('report-subtitle').innerText = data.subtitle;
            document.getElementById('pop-date').innerText = data.date;
            document.getElementById('pop-rev').innerText = data.rev;
            document.getElementById('current-pop-label').innerText = currentPOP.toUpperCase();

            const contentDiv = document.getElementById('dynamic-content');
            contentDiv.innerHTML = '';

            data.groups.forEach((group, index) => {
                if (!currentVisibleGroups.includes(index)) return; 

                const section = document.createElement('section');
                section.className = "mb-8 print:mb-4"; 
                
                section.innerHTML = `
                    <h3 class="text-lg font-bold text-emerald-800 border-l-4 border-emerald-600 pl-3 mb-4 bg-emerald-50 py-2">
                        ${group.title}
                    </h3>
                    <div class="space-y-4 print:space-y-2" id="group-${index}"></div>
                `;
                
                contentDiv.appendChild(section);

                const groupContainer = section.querySelector(`div[id^="group-"]`);
                
                group.questions.forEach(q => {
                    const html = `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow question-container">
                        <p class="font-medium text-gray-800 mb-2 text-sm md:text-base">${q.text}</p>
                        
                        <div class="flex flex-wrap gap-2 mb-3 print:mb-1">
                            <div>
                                <input type="radio" name="${q.id}" id="${q.id}_C" value="C" class="hidden radio-option" onchange="saveProgress()">
                                <label for="${q.id}_C" class="cursor-pointer px-4 py-2 rounded border border-gray-300 text-sm font-bold text-gray-600 hover:bg-gray-100 transition select-none flex items-center gap-1 radio-label">
                                    <i data-lucide="check-circle" class="w-4 h-4 print:hidden"></i> C
                                </label>
                            </div>
                            <div>
                                <input type="radio" name="${q.id}" id="${q.id}_NC" value="NC" class="hidden radio-option" onchange="saveProgress()">
                                <label for="${q.id}_NC" class="cursor-pointer px-4 py-2 rounded border border-gray-300 text-sm font-bold text-gray-600 hover:bg-red-50 hover:text-red-600 hover:border-red-300 transition select-none flex items-center gap-1 radio-label">
                                    <i data-lucide="x-circle" class="w-4 h-4 print:hidden"></i> NC
                                </label>
                            </div>
                            <div>
                                <input type="radio" name="${q.id}" id="${q.id}_NA" value="NA" class="hidden radio-option" onchange="saveProgress()">
                                <label for="${q.id}_NA" class="cursor-pointer px-4 py-2 rounded border border-gray-300 text-sm font-bold text-gray-600 hover:bg-gray-100 transition select-none radio-label">
                                    NA
                                </label>
                            </div>
                        </div>
                        
                        <div class="mt-2">
                            <!-- Label fora da caixa para não atrapalhar a escrita manual -->
                            <label for="obs_${q.id}" class="text-xs text-gray-500 font-semibold mb-1 block print:text-black">Observações:</label>
                            <textarea id="obs_${q.id}" rows="2" class="w-full text-sm p-2 border border-gray-300 rounded focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none bg-gray-50" oninput="saveProgress()"></textarea>
                        </div>
                    </div>
                    `;
                    groupContainer.insertAdjacentHTML('beforeend', html);
                });
            });

            lucide.createIcons();
            updateStats();
        }

        // --- PREENCHIMENTO DE DADOS (Load) ---
        function fillFormData(data) {
            if(data.meta) {
                // Atualizar tanto inputs de tela quanto de impressão
                const resp = data.meta.responsavel || '';
                const setor = data.meta.setor || '';
                
                document.getElementById('responsavel-screen').value = resp;
                document.getElementById('responsavel-print').value = resp;
                
                document.getElementById('setor-screen').value = setor;
                document.getElementById('setor-print').value = setor;
                
                const dateVal = data.meta.data || '';
                const dateScreen = document.getElementById('data-screen');
                const datePrint = document.getElementById('data-print');
                
                dateScreen.value = dateVal;
                datePrint.value = dateVal;
                
                if(dateVal) {
                    dateScreen.classList.add('has-value');
                    datePrint.classList.add('has-value');
                } else {
                    dateScreen.classList.remove('has-value');
                    datePrint.classList.remove('has-value');
                }
                
                document.getElementById('obs-geral').value = data.meta.obsGeral || '';
                document.getElementById('aprovado-por').value = data.meta.aprovadoPor || '';
                document.getElementById('assinatura-digital').value = data.meta.assinaturaDigital || ''; // Carregar assinatura texto
            }

            if(data.answers) {
                Object.keys(data.answers).forEach(key => {
                    const item = data.answers[key];
                    const radio = document.getElementById(`${key}_${item.val}`);
                    if (radio) radio.checked = true;
                    
                    const obsInput = document.getElementById(`obs_${key}`);
                    if (obsInput && item.obs) obsInput.value = item.obs;
                });
            }
        }

        // --- SALVAMENTO (Save) ---
        function saveProgress() {
            // Pegar valor de qualquer um dos inputs de data (estão sincronizados)
            const dateVal = document.getElementById('data-screen').value;
            
            const storageKey = `data_${currentPOP}`;
            
            const oldData = JSON.parse(localStorage.getItem(storageKey)) || { answers: {} };
            const newAnswers = { ...oldData.answers }; 
            
            popsData[currentPOP].groups.forEach((group, index) => {
                if(currentVisibleGroups.includes(index)) {
                    group.questions.forEach(q => {
                        const selected = document.querySelector(`input[name="${q.id}"]:checked`);
                        const obs = document.getElementById(`obs_${q.id}`)?.value;
                        
                        if (selected || obs) {
                            newAnswers[q.id] = {
                                val: selected ? selected.value : null,
                                obs: obs
                            };
                        } else {
                            delete newAnswers[q.id];
                        }
                    });
                }
            });

            const data = {
                meta: {
                    responsavel: document.getElementById('responsavel-screen').value,
                    setor: document.getElementById('setor-screen').value,
                    data: dateVal,
                    obsGeral: document.getElementById('obs-geral').value,
                    aprovadoPor: document.getElementById('aprovado-por').value,
                    assinaturaDigital: document.getElementById('assinatura-digital').value, // Salvar o campo de texto
                    visibleGroups: currentVisibleGroups
                },
                answers: newAnswers
            };

            localStorage.setItem(storageKey, JSON.stringify(data));
            updateStats();
        }

        // --- EXPORTAR CSV ---
        function exportToCSV() {
            const dataStr = localStorage.getItem(`data_${currentPOP}`);
            if(!dataStr) {
                alert("Nenhum dado salvo para exportar neste POP.");
                return;
            }
            
            const data = JSON.parse(dataStr);
            const popInfo = popsData[currentPOP];
            const rows = [];
            
            // Cabeçalho do CSV
            rows.push(['POP', 'Titulo POP', 'Data Avaliacao', 'Responsavel', 'Setor', 'Aprovado Por', 'Assinatura', 'Grupo', 'Pergunta ID', 'Pergunta', 'Resposta', 'Observacao']);
            
            // Dados Meta
            const metaBase = [
                currentPOP.toUpperCase(), 
                popInfo.title, 
                data.meta.data || '', 
                data.meta.responsavel || '', 
                data.meta.setor || '',
                data.meta.aprovadoPor || '',
                data.meta.assinaturaDigital || ''
            ];

            // Iterar sobre as respostas
            if(data.answers) {
                // Percorrer todas as perguntas do POP atual para garantir ordem
                popInfo.groups.forEach(group => {
                    group.questions.forEach(q => {
                        const ans = data.answers[q.id];
                        if(ans) {
                            // Mapear valor (C/NC/NA) para texto legível se necessário, ou manter sigla
                            const resposta = ans.val || ''; 
                            const obs = ans.obs ? ans.obs.replace(/\n/g, ' ') : ''; // Remover quebras de linha da obs
                            
                            // Adicionar linha
                            rows.push([...metaBase, group.title, q.id, q.text, resposta, obs]);
                        }
                    });
                });
            }
            
            // Adicionar Observação Geral se houver
            if(data.meta.obsGeral) {
                 rows.push([...metaBase, 'Geral', 'OBS_GERAL', 'Observações Gerais', '', data.meta.obsGeral.replace(/\n/g, ' ')]);
            }

            // Converter para string CSV
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM para acentos
            rows.forEach(rowArray => {
                const row = rowArray.map(item => {
                    // Escapar aspas duplas e envolver em aspas se tiver vírgula
                    const str = String(item).replace(/"/g, '""');
                    return `"${str}"`;
                }).join(",");
                csvContent += row + "\r\n";
            });

            // Download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `Relatorio_${currentPOP.toUpperCase()}_${data.meta.data || 'sem_data'}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateStats() {
            let totalApplicable = 0;
            let compliant = 0;
            let nonCompliant = 0;

            popsData[currentPOP].groups.forEach((group, index) => {
                if (!currentVisibleGroups.includes(index)) return;

                group.questions.forEach(q => {
                    const selected = document.querySelector(`input[name="${q.id}"]:checked`);
                    if (selected) {
                        if (selected.value === 'C') {
                            compliant++;
                            totalApplicable++;
                        } else if (selected.value === 'NC') {
                            nonCompliant++;
                            totalApplicable++;
                        }
                    }
                });
            });

            const percentage = totalApplicable === 0 ? 0 : Math.round((compliant / totalApplicable) * 100);
            
            const scoreEl = document.getElementById('score-display');
            scoreEl.innerText = `${percentage}%`;
            
            if(percentage >= 90) scoreEl.className = "text-2xl font-bold text-emerald-600";
            else if(percentage >= 70) scoreEl.className = "text-2xl font-bold text-yellow-600";
            else scoreEl.className = "text-2xl font-bold text-red-600";

            document.getElementById('count-c').innerText = compliant;
            document.getElementById('count-nc').innerText = nonCompliant;
        }

        function resetForm() {
            if(confirm(`Tem certeza que deseja limpar as respostas do ${currentPOP.toUpperCase()}?`)) {
                localStorage.removeItem(`data_${currentPOP}`);
                changePOP(); 
            }
        }
    </script>
</body>
</html>
